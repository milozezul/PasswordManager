@using PManagerFrontend.Interfaces.Services
@using SharedModels.DataService
@inject IDirectLinkService _direct
@inject IConfiguration _config
@inject IDataService _data

<div class="flex flex-row gap-x-1 px-1 h-10 w-full">
    <div class="flex flex-row basis-1/10">
        @if (Password.IsActive)
        {
            <button class="grow-1 bg-red-300 text-white px-1 hover:bg-orange-600 text-xs font-light" @onclick="DisablePassword">DEACTIVATE</button>
        }
        else
        {
            <button class="grow-1 bg-green-400 text-white px-1 hover:bg-green-600 text-xs font-light" @onclick="EnablePassword">ACTIVATE</button>
        }
        
        <button class="grow-1 bg-sky-400 text-white px-1 hover:bg-sky-600 text-xs font-light" @onclick="OnShare">SHARE</button>
    </div>
    @if(IsShare)
    {
        <div class="basis-1/15">
            <button class="bg-sky-400 text-white px-1 py-2 h-10 hover:bg-sky-600 text-xs font-light" @onclick="GenerateToken">GENERATE</button>
        </div>
        <div class="flex flex-col basis-2/10 gap-x-1">
            <div class="flex flex-row items-center basis-1/3">
                <div class="text-xs text-white text-left w-full">Fallback Value</div>
            </div>
            <div class="basis-2/3">
                <input type="text" class="pl-2 text-gray-900 bg-gray-200 w-full text-sm" @bind-value:event="oninput" @bind-value="@FallBackValue" />
            </div>            
        </div>
        
        
        <div class="flex flex-col basis-2/10 gap-x-1">            
            <div class="flex flex-row">
                <div class="text-xs text-white">URL</div>
            </div>
            <div>
                <input type="text" class="pl-2 text-gray-100 bg-gray-900 w-full text-sm" disabled value="@(_config.GetSection("API").GetSection("BaseUrl").Get<string>() ?? "")/api/DirectAccess/enter" />
            </div>
        </div>
        
        <div class="flex flex-col basis-2/10 gap-x-1">            
            <div class="flex flex-row">
                <div class="text-xs text-white text-left">Auth Token</div>
            </div>
            <div>
                <input type="text" class="pl-2 text-gray-100 bg-gray-900 w-full text-sm" disabled @bind-value="DirectPasswordToken" />
            </div>
        </div>
        
        <div class="flex flex-col basis-2/10 gap-x-1">
            <div class="flex flex-row">
                <div class="text-xs text-white text-left">Request Body</div>
            </div>
            <div>
                <input type="text" class="pl-2 text-gray-100 bg-gray-900 w-full text-sm" disabled value=@("{\"password\":\"\"}")/>
            </div>
        </div>                
    }
</div>

@code {
    bool IsShare { get; set; }

    string FallBackValue { get; set; }
    string DirectPasswordToken { get; set; }

    [Parameter, EditorRequired]
    public DecryptedPassword Password { get; set; }
    [Parameter, EditorRequired]
    public int RecordId { get; set; }
    [Parameter, EditorRequired]
    public string LockPassword { get; set; }

    void OnShare()
    {
        IsShare = !IsShare;
    }

    async Task GenerateToken()
    {
        var result = await _direct.GetDirectToken(new SharedModels.InputModels.LinkInput()
        {
            Fallback = FallBackValue,
            PasswordId = Password.Id,
            RecordId = RecordId,
        });

        if (!string.IsNullOrEmpty(result.Value))
        {
            DirectPasswordToken = result.Value;
        }
        else
        {
            DirectPasswordToken = result.Message;
        }
    }

    async Task DisablePassword()
    {
        await _data.DiactivatePassword(RecordId, Password.Id, LockPassword);
    }

    async Task EnablePassword()
    {
        await _data.ActivatePassword(RecordId, Password.Id, LockPassword);
    }
}
